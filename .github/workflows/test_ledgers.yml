name: Replay Ledgers
on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [synchronize, opened, reopened, ready_for_review]
  merge_group:
jobs:
  ledger-replay:
    runs-on: private
    if: github.event.pull_request.draft == false
    env:
      CC: gcc
      EXTRAS: no-solana
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/deps
      - uses: ./.github/actions/hugepages
        with:
          count_gigantic: 300
          count_huge: 1000 # TODO: this is required until we can handle anonymouse workspaces and loose huge pages in fddev

      - name: build
        run: |
          make -j bin
      - name: test replay ledgers
        run: |
          sudo prlimit --pid=$$ --nofile=1048576
          sudo prlimit --pid=$$ --memlock=unlimited
          make run-runtime-test
