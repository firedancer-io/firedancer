#include "fd_eqvoc.h"
#include <stdlib.h>

static const uchar shred13_code_bytes[FD_SHRED_MAX_SZ];
static const uchar shred15_code_bytes[FD_SHRED_MAX_SZ];
static const uchar shred13_data_bytes[FD_SHRED_MIN_SZ];
static const uchar shred13_data_bytes_eqvoc[FD_SHRED_MIN_SZ];

void
test_eqvoc_test( fd_eqvoc_t * eqvoc ) {

  fd_shred_t * shred13_code = (fd_shred_t *)shred13_code_bytes;
  fd_shred_t * shred15_code = (fd_shred_t *)shred15_code_bytes;

  fd_shred_t * shred13_data       = (fd_shred_t *)shred13_data_bytes;
  fd_shred_t * shred13_data_eqvoc = (fd_shred_t *)shred13_data_bytes_eqvoc;

  /* Insert 13-15, 15-20 */

  FD_TEST( !fd_eqvoc_search( eqvoc, shred15_code ) );
  fd_eqvoc_insert( eqvoc, shred13_code );
  FD_TEST( fd_eqvoc_search( eqvoc, shred15_code ) );

  FD_TEST( fd_eqvoc_test( eqvoc, shred13_code, shred15_code ) );
  FD_TEST( fd_eqvoc_test( eqvoc, shred13_data, shred13_data_eqvoc ) );

  FD_TEST( !fd_eqvoc_test( eqvoc, shred13_code, shred13_code ) );
  FD_TEST( !fd_eqvoc_test( eqvoc, shred13_data, shred13_data ) );
}

void
test_eqvoc_from_chunks( fd_eqvoc_t * eqvoc,
                        fd_alloc_t * alloc,
                        ulong        shred1_sz,
                        ulong        shred2_sz,
                        ulong        chunk_len ) {
  uchar *      shred1_bytes = fd_alloc_malloc( alloc, 1, shred1_sz );
  fd_shred_t * shred1_out   = (fd_shred_t *)fd_type_pun( shred1_bytes );
  uchar *      shred2_bytes = fd_alloc_malloc( alloc, 1, shred2_sz );
  fd_shred_t * shred2_out   = (fd_shred_t *)fd_type_pun( shred2_bytes );

  ulong sz        = ( shred1_sz + shred2_sz );
  uchar chunk_cnt = (uchar)( sz / chunk_len );
  chunk_cnt       = fd_uchar_if( (int)( sz % chunk_len ), (uchar)( chunk_cnt + 1 ), chunk_cnt );

  fd_gossip_duplicate_shred_t duplicate_shreds[chunk_cnt];
  for( uchar chunk_idx = 0; chunk_idx < chunk_cnt; chunk_idx++ ) {
    duplicate_shreds[chunk_idx].num_chunks  = chunk_cnt;
    duplicate_shreds[chunk_idx].chunk_index = chunk_idx;
    duplicate_shreds[chunk_idx].chunk_len   = chunk_len;
    duplicate_shreds[chunk_idx].chunk       = fd_alloc_malloc( alloc, 1, chunk_len );
  }

  uchar shred1_ascii[6] = { 0x73, 0x68, 0x72, 0x65, 0x64, 0x31 };
  for( ulong i = 0; i < shred1_sz; i++ ) {
    if( FD_UNLIKELY( i == FD_SHRED_VARIANT_OFF ) ) {
      uchar variant = fd_uchar_if( shred1_sz == FD_SHRED_MIN_SZ,
                                   FD_SHRED_TYPE_MERKLE_DATA_CHAINED,
                                   FD_SHRED_TYPE_MERKLE_CODE_CHAINED );
      duplicate_shreds[i / chunk_len].chunk[i % chunk_len] = variant;
    } else {
      duplicate_shreds[i / chunk_len].chunk[i % chunk_len] = shred1_ascii[i % 6];
    }
  }

  uchar shred2_ascii[6] = { 0x73, 0x68, 0x72, 0x65, 0x64, 0x32 };
  for( ulong i = shred1_sz; i < shred1_sz + shred2_sz; i++ ) {
    if( FD_UNLIKELY( i == FD_SHRED_VARIANT_OFF ) ) {
      uchar variant = fd_uchar_if( shred2_sz == FD_SHRED_MIN_SZ,
                                   FD_SHRED_TYPE_MERKLE_DATA_CHAINED,
                                   FD_SHRED_TYPE_MERKLE_CODE_CHAINED );
      duplicate_shreds[i / chunk_len].chunk[i % chunk_len] = variant;
    } else {
      duplicate_shreds[i / chunk_len].chunk[i % chunk_len] = shred2_ascii[i % 6];
    }
  }

  fd_eqvoc_from_chunks( eqvoc, duplicate_shreds, shred1_out, shred2_out );

  /* Check the shred1 chunks */

  ulong k = shred1_sz / chunk_len;
  for( ulong i = 0; i < k; i++ ) {
    FD_TEST( 0 == memcmp( duplicate_shreds[i].chunk, shred1_bytes + i * chunk_len, chunk_len ) );
  }

  /* Check the kth chunk contains both shred1 and shred2 */

  ulong rem = shred1_sz - ( k * chunk_len );
  FD_TEST( 0 == memcmp( duplicate_shreds[k].chunk, shred1_bytes + ( k * chunk_len ), rem ) );
  ulong off = chunk_len - rem;
  FD_TEST( 0 == memcmp( duplicate_shreds[k].chunk + rem, shred2_bytes, off ) );

  /* Check the shred2 chunks */

  for( ulong i = k + 1; i < chunk_cnt; i++ ) {
    FD_TEST( 0 == memcmp( duplicate_shreds[i].chunk,
                          shred2_bytes + off,
                          fd_ulong_min( chunk_len, shred2_sz - off ) ) );
    off += chunk_len;
  }

  // for (ulong i = 0; i < k; i ++) {
  //   FD_TEST( 0 == memcmp( duplicate_shreds[2].chunk, shred2_bytes + len, shred2_sz - len ) );
  // }

  // FD_TEST( 0 == memcmp( duplicate_shreds[0].chunk, shred1_bytes, chunk_len ) );
  // ulong rem = shred1_sz - chunk_len;
  // FD_TEST( 0 == memcmp( duplicate_shreds[1].chunk, shred1_bytes + chunk_len, rem ) );
  // ulong len = chunk_len - rem;
  // FD_TEST( 0 == memcmp( duplicate_shreds[1].chunk + rem, shred2_bytes, len ) );
  // FD_TEST( 0 == memcmp( duplicate_shreds[2].chunk, shred2_bytes + len, shred2_sz - len ) );
}

void
test_eqvoc_to_chunks( fd_eqvoc_t * eqvoc,
                      fd_alloc_t * alloc,
                      ulong        shred1_sz,
                      ulong        shred2_sz,
                      ulong        chunk_len ) {
  uchar * shred1_bytes = fd_alloc_malloc( alloc, 1, shred1_sz );
  uchar * shred2_bytes = fd_alloc_malloc( alloc, 1, shred2_sz );

  uchar shred1_ascii[6] = { 0x73, 0x68, 0x72, 0x65, 0x64, 0x31 };
  uchar shred2_ascii[6] = { 0x73, 0x68, 0x72, 0x65, 0x64, 0x32 };

  for( ulong i = 0; i < shred1_sz; i++ ) {
    shred1_bytes[i] = shred1_ascii[i % 6];
  }
  for( ulong i = 0; i < shred2_sz; i++ ) {
    shred2_bytes[i] = shred2_ascii[i % 6];
  }

  fd_shred_t * shred1 = (fd_shred_t *)fd_type_pun( shred1_bytes );
  shred1->variant     = fd_uchar_if( shred1_sz == FD_SHRED_MIN_SZ,
                                 FD_SHRED_TYPE_MERKLE_DATA_CHAINED,
                                 FD_SHRED_TYPE_MERKLE_CODE_CHAINED );
  fd_shred_t * shred2 = (fd_shred_t *)fd_type_pun( shred2_bytes );
  shred2->variant     = fd_uchar_if( shred2_sz == FD_SHRED_MIN_SZ,
                                 FD_SHRED_TYPE_MERKLE_DATA_CHAINED,
                                 FD_SHRED_TYPE_MERKLE_CODE_CHAINED );

  ulong sz        = ( shred1_sz + shred2_sz );
  ulong chunk_cnt = sz / chunk_len;
  chunk_cnt       = fd_ulong_if( (int)( sz % chunk_len ), chunk_cnt + 1, chunk_cnt );

  fd_gossip_duplicate_shred_t duplicate_shreds[chunk_cnt];
  for( ulong i = 0; i < chunk_cnt; i++ ) {
    duplicate_shreds[i].chunk = fd_alloc_malloc( alloc, 1, chunk_len );
  }

  fd_eqvoc_to_chunks( eqvoc, shred1, shred2, chunk_len, duplicate_shreds );

  /* Check the shred1 chunks */

  ulong k = shred1_sz / chunk_len;
  for( ulong i = 0; i < k; i++ ) {
    FD_TEST( 0 == memcmp( duplicate_shreds[i].chunk, shred1_bytes + i * chunk_len, chunk_len ) );
  }

  /* Check the kth chunk contains both shred1 and shred2 */

  ulong rem = shred1_sz - ( k * chunk_len );
  FD_TEST( 0 == memcmp( duplicate_shreds[k].chunk, shred1_bytes + ( k * chunk_len ), rem ) );
  ulong off = chunk_len - rem;
  FD_TEST( 0 == memcmp( duplicate_shreds[k].chunk + rem, shred2_bytes, off ) );

  /* Check the shred2 chunks */

  for( ulong i = k + 1; i < chunk_cnt; i++ ) {
    FD_TEST( 0 == memcmp( duplicate_shreds[i].chunk,
                          shred2_bytes + off,
                          fd_ulong_min( chunk_len, shred2_sz - off ) ) );
    off += chunk_len;
  }
}

int
main( int argc, char ** argv ) {
  fd_boot( &argc, &argv );

  ulong  page_cnt = 1;
  char * _page_sz = "gigantic";
  ulong  numa_idx = fd_shmem_numa_idx( 0 );
  FD_LOG_NOTICE( ( "Creating workspace (--page-cnt %lu, --page-sz %s, --numa-idx %lu)",
                   page_cnt,
                   _page_sz,
                   numa_idx ) );
  fd_wksp_t * wksp = fd_wksp_new_anonymous( fd_cstr_to_shmem_page_sz( _page_sz ),
                                            page_cnt,
                                            fd_shmem_cpu_idx( numa_idx ),
                                            "wksp",
                                            0UL );
  FD_TEST( wksp );


  fd_pubkey_t pub[1] = {
      { .uc = { 242, 97, 238, 195, 95, 84,  158, 41, 211, 104, 141, 25, 22,  233, 147, 28,
                8,   50, 225, 227, 88, 116, 4,   29, 207, 7,   22,  4,  141, 136, 237, 132 } } };
  uint sched[100] = { 0 };

  fd_epoch_leaders_t leaders =
      { .slot0 = 0, .slot_cnt = 100, .pub = pub, .pub_cnt = 1, .sched = sched, .sched_cnt = 4 };

  ulong  key_max   = 1 << 10UL;
  void * eqvoc_mem = fd_wksp_alloc_laddr( wksp,
                                          fd_eqvoc_align(),
                                          fd_eqvoc_footprint( key_max ),
                                          1UL );
  FD_TEST( eqvoc_mem );
  fd_eqvoc_t * eqvoc = fd_eqvoc_join( fd_eqvoc_new( eqvoc_mem, key_max, 0UL ) );

  eqvoc->min_slot = 42;
  eqvoc->key_max = key_max;
  eqvoc->shred_version = 42;
  eqvoc->leaders = &leaders;

  void *       alloc_mem = fd_wksp_alloc_laddr( wksp, fd_alloc_align(), fd_alloc_footprint(), 1UL );
  fd_alloc_t * alloc     = fd_alloc_join( fd_alloc_new( alloc_mem, 1UL ), 1UL );

  test_eqvoc_test( eqvoc );

  // test_eqvoc_to_chunks( eqvoc, FD_SHRED_MAX_SZ, FD_SHRED_MAX_SZ, FD_EQVOC_CHUNK_MAX );

  ulong shred_szs[2]  = { FD_SHRED_MIN_SZ, FD_SHRED_MAX_SZ };
  ulong chunk_lens[4] = { FD_EQVOC_CHUNK_MAX, 117, 42, 10 };

  for( ulong i = 0; i < sizeof( shred_szs ) / sizeof( ulong ); i++ ) {
    for( ulong j = 0; j < sizeof( shred_szs ) / sizeof( ulong ); j++ ) {
      for( ulong k = 0; k < sizeof( chunk_lens ) / sizeof( ulong ); k++ ) {
        test_eqvoc_from_chunks( eqvoc, alloc, shred_szs[i], shred_szs[j], chunk_lens[k] );
        test_eqvoc_to_chunks( eqvoc, alloc, shred_szs[i], shred_szs[j], chunk_lens[k] );
      }
    }
  }

  fd_wksp_free_laddr( eqvoc_mem );

  fd_halt();
  return 0;
}

static const uchar shred13_code_bytes[FD_SHRED_MAX_SZ] = {
    231, 55,  111, 140, 57,  159, 84,  2,   69,  28,  60,  138, 91,  207, 27,  144, 226, 213, 244,
    133, 134, 71,  120, 190, 239, 225, 110, 38,  196, 207, 75,  201, 149, 131, 80,  231, 218, 244,
    168, 179, 253, 221, 211, 118, 147, 243, 170, 234, 173, 89,  247, 74,  63,  110, 65,  232, 94,
    234, 146, 221, 121, 249, 194, 15,  69,  42,  0,   0,   0,   0,   0,   0,   0,   208, 0,   0,
    0,   42,  0,   13,  0,   0,   0,   3,   0,   19,  0,   0,   0,   133, 42,  0,   0,   0,   0,
    0,   0,   0,   12,  0,   0,   0,   42,  0,   13,  0,   0,   0,   1,   0,   106, 34,  4,   111,
    137, 126, 193, 31,  17,  240, 103, 195, 254, 170, 63,  235, 168, 91,  178, 230, 57,  120, 184,
    53,  227, 250, 166, 188, 128, 24,  65,  228, 3,   190, 59,  178, 14,  24,  3,   101, 50,  148,
    7,   233, 119, 7,   48,  51,  60,  46,  144, 252, 140, 38,  175, 18,  76,  144, 235, 131, 24,
    210, 231, 28,  45,  190, 213, 105, 151, 248, 159, 93,  54,  239, 128, 87,  6,   44,  157, 25,
    192, 176, 193, 207, 85,  173, 35,  3,   201, 52,  240, 13,  152, 204, 49,  204, 243, 253, 37,
    214, 29,  26,  23,  188, 0,   197, 29,  159, 59,  170, 222, 67,  117, 0,   36,  61,  131, 222,
    4,   94,  73,  250, 70,  117, 4,   114, 239, 199, 92,  222, 177, 222, 172, 59,  138, 231, 107,
    195, 72,  17,  243, 24,  175, 37,  52,  184, 96,  228, 188, 124, 51,  201, 115, 205, 6,   232,
    247, 159, 72,  239, 224, 106, 202, 2,   113, 25,  126, 157, 179, 159, 52,  199, 107, 240, 50,
    117, 255, 37,  50,  246, 203, 233, 186, 47,  240, 225, 135, 63,  27,  29,  181, 15,  9,   43,
    151, 69,  35,  124, 63,  31,  104, 94,  210, 11,  69,  252, 97,  175, 176, 244, 122, 43,  61,
    104, 17,  168, 77,  113, 226, 74,  20,  187, 63,  25,  134, 101, 98,  24,  204, 243, 104, 171,
    24,  105, 232, 88,  123, 12,  241, 219, 182, 196, 193, 29,  141, 227, 207, 170, 183, 4,   244,
    45,  170, 85,  101, 90,  223, 171, 167, 56,  203, 164, 127, 48,  139, 147, 241, 89,  144, 189,
    108, 52,  176, 154, 167, 31,  203, 100, 138, 242, 98,  144, 46,  204, 143, 12,  48,  111, 202,
    34,  191, 213, 118, 76,  132, 111, 120, 237, 212, 43,  101, 79,  56,  173, 143, 15,  207, 188,
    241, 66,  30,  62,  5,   194, 191, 148, 191, 234, 3,   233, 33,  26,  199, 72,  81,  147, 120,
    60,  10,  111, 182, 21,  108, 35,  148, 136, 217, 187, 209, 219, 62,  197, 33,  212, 166, 135,
    158, 166, 207, 179, 229, 80,  186, 245, 69,  90,  4,   77,  117, 71,  193, 140, 165, 206, 254,
    16,  38,  88,  162, 233, 144, 108, 113, 187, 180, 227, 192, 208, 236, 86,  34,  154, 134, 104,
    121, 11,  30,  142, 90,  170, 59,  163, 218, 194, 133, 248, 178, 236, 159, 135, 150, 57,  160,
    176, 147, 236, 130, 15,  68,  246, 205, 103, 119, 185, 59,  58,  180, 178, 79,  148, 32,  247,
    110, 102, 201, 154, 162, 121, 126, 233, 66,  76,  115, 110, 239, 151, 86,  167, 213, 79,  217,
    87,  126, 19,  236, 9,   202, 26,  110, 252, 63,  41,  23,  87,  96,  29,  129, 168, 203, 7,
    37,  122, 110, 251, 5,   48,  179, 144, 171, 219, 146, 129, 112, 97,  106, 239, 42,  55,  92,
    116, 246, 108, 204, 18,  175, 66,  94,  27,  144, 34,  115, 57,  192, 167, 133, 43,  71,  36,
    134, 0,   205, 9,   142, 44,  137, 195, 105, 33,  120, 191, 187, 36,  8,   44,  48,  96,  7,
    100, 112, 181, 129, 184, 238, 226, 65,  236, 216, 66,  145, 54,  121, 168, 8,   254, 116, 187,
    3,   146, 239, 90,  228, 13,  5,   173, 224, 85,  193, 62,  111, 190, 7,   25,  196, 243, 50,
    13,  194, 151, 48,  180, 75,  89,  91,  157, 56,  159, 137, 129, 31,  188, 30,  203, 192, 29,
    188, 226, 205, 210, 246, 179, 191, 12,  21,  119, 77,  161, 182, 152, 202, 124, 58,  95,  102,
    250, 170, 198, 233, 186, 121, 45,  175, 242, 253, 17,  142, 229, 150, 16,  200, 232, 57,  212,
    143, 199, 95,  217, 246, 20,  197, 124, 155, 23,  12,  174, 113, 6,   182, 171, 195, 38,  166,
    142, 77,  52,  247, 144, 59,  111, 200, 63,  78,  70,  195, 42,  18,  184, 252, 116, 217, 231,
    93,  223, 215, 188, 189, 57,  60,  101, 173, 166, 75,  213, 29,  79,  90,  10,  88,  41,  3,
    6,   181, 225, 49,  90,  44,  174, 209, 247, 133, 12,  35,  75,  91,  177, 104, 165, 184, 127,
    35,  70,  43,  248, 66,  191, 67,  227, 203, 152, 183, 43,  121, 211, 254, 203, 40,  189, 40,
    237, 113, 60,  37,  46,  141, 106, 128, 23,  136, 30,  96,  237, 76,  150, 205, 235, 205, 46,
    77,  187, 231, 111, 30,  90,  113, 107, 60,  116, 196, 171, 126, 207, 51,  123, 158, 227, 84,
    66,  23,  158, 98,  168, 161, 45,  66,  118, 23,  67,  42,  215, 26,  255, 49,  144, 150, 10,
    39,  2,   7,   71,  85,  225, 193, 72,  219, 234, 193, 6,   208, 188, 219, 105, 207, 84,  198,
    244, 175, 90,  60,  154, 156, 25,  3,   153, 103, 118, 91,  225, 8,   84,  100, 105, 3,   190,
    215, 47,  150, 136, 47,  156, 141, 44,  149, 120, 119, 44,  99,  5,   255, 44,  97,  65,  250,
    104, 8,   242, 150, 153, 229, 255, 50,  23,  157, 200, 159, 24,  174, 14,  115, 138, 193, 1,
    224, 182, 113, 127, 81,  181, 36,  169, 129, 141, 47,  45,  184, 174, 199, 22,  200, 191, 62,
    248, 64,  84,  180, 68,  128, 128, 218, 255, 40,  151, 210, 86,  154, 196, 122, 246, 255, 179,
    230, 216, 122, 69,  97,  36,  132, 84,  171, 169, 228, 206, 163, 3,   29,  213, 149, 187, 76,
    79,  189, 27,  184, 13,  111, 209, 240, 130, 88,  66,  85,  88,  25,  212, 213, 44,  217, 162,
    176, 217, 71,  71,  54,  72,  131, 67,  64,  21,  166, 50,  122, 230, 89,  106, 123, 131, 148,
    144, 98,  35,  124, 156, 42,  98,  131, 8,   241, 119, 202, 97,  85,  172, 50,  155, 117, 50,
    226, 100, 10,  96,  230, 88,  3,   153, 120, 122, 72,  253, 197, 169, 115, 79,  115, 37,  112,
    119, 144, 83,  93,  29,  12,  207, 140, 109, 30,  131, 153, 114, 183, 246, 174, 18,  10,  45,
    12,  231, 252, 179, 193, 182, 239, 125, 171, 0,   37,  106, 124, 78,  143, 252, 4,   249, 244,
    58,  116, 3,   71,  199, 11,  62,  90,  193, 243, 253, 91,  60,  253, 148, 124, 164, 1,   204,
    186, 245, 154, 238, 6,   7,   126, 68,  216, 172, 96,  221, 18,  166, 174, 169, 84,  221, 158,
    156, 180, 184, 132, 133, 105, 146, 244, 35,  87,  73,  156, 128, 12,  201, 2,   253, 192, 7,
    145, 151, 218, 14,  97,  14,  219, 139, 186, 84,  168, 121, 3,   126, 126, 189, 130, 199, 150,
    93,  107, 162, 139, 27,  22,  57,  139, 140, 148, 208, 125, 171, 41,  253, 125, 80,  59,  60,
    240, 117, 114, 248, 60,  188, 94,  70,  62,  35,  141, 193 };

static const uchar shred15_code_bytes[FD_SHRED_MAX_SZ] = {
    188, 5,   217, 105, 26,  255, 20,  92,  10,  44,  3,   73,  168, 161, 81,  146, 64,  209, 2,
    222, 195, 207, 61,  132, 167, 236, 49,  45,  241, 49,  174, 80,  220, 120, 34,  53,  240, 248,
    70,  27,  70,  120, 160, 234, 133, 156, 95,  57,  26,  66,  242, 43,  146, 116, 227, 252, 66,
    247, 100, 19,  122, 60,  120, 1,   69,  42,  0,   0,   0,   0,   0,   0,   0,   208, 0,   0,
    0,   42,  0,   15,  0,   0,   0,   3,   0,   19,  0,   0,   0,   133, 42,  0,   0,   0,   0,
    0,   0,   0,   14,  0,   0,   0,   42,  0,   15,  0,   0,   0,   1,   0,   106, 34,  4,   128,
    61,  215, 89,  181, 23,  104, 216, 73,  204, 178, 124, 4,   225, 255, 70,  209, 154, 102, 57,
    92,  122, 118, 249, 53,  245, 243, 64,  244, 203, 54,  65,  66,  170, 194, 200, 71,  135, 116,
    101, 1,   185, 161, 185, 154, 29,  131, 168, 179, 30,  39,  73,  47,  228, 185, 130, 175, 84,
    249, 155, 248, 157, 113, 172, 92,  93,  43,  162, 13,  120, 126, 80,  233, 44,  76,  225, 22,
    76,  48,  73,  219, 171, 187, 25,  201, 105, 228, 33,  246, 150, 5,   74,  41,  197, 158, 137,
    172, 65,  202, 6,   10,  134, 119, 120, 65,  18,  155, 0,   86,  171, 117, 186, 174, 63,  81,
    127, 5,   146, 142, 120, 48,  225, 58,  149, 130, 104, 59,  169, 195, 32,  172, 85,  229, 169,
    143, 159, 52,  163, 125, 85,  52,  97,  245, 45,  152, 110, 219, 53,  163, 181, 110, 70,  219,
    131, 76,  120, 241, 64,  214, 150, 62,  129, 141, 187, 58,  1,   119, 243, 106, 171, 25,  117,
    212, 251, 244, 166, 85,  239, 207, 48,  132, 201, 4,   16,  78,  243, 25,  120, 133, 18,  126,
    11,  175, 94,  33,  123, 220, 73,  150, 0,   69,  224, 95,  203, 65,  22,  139, 89,  229, 169,
    155, 132, 230, 214, 115, 66,  43,  17,  94,  122, 38,  255, 67,  106, 155, 248, 183, 29,  221,
    108, 254, 189, 59,  55,  193, 83,  157, 109, 65,  33,  130, 206, 45,  44,  213, 8,   138, 218,
    179, 5,   141, 149, 210, 244, 86,  156, 76,  96,  127, 136, 247, 11,  49,  56,  10,  99,  139,
    225, 67,  73,  131, 247, 163, 178, 78,  159, 146, 66,  73,  254, 189, 247, 51,  71,  143, 36,
    247, 123, 38,  27,  12,  241, 29,  221, 35,  219, 11,  237, 39,  162, 39,  79,  201, 179, 249,
    62,  38,  163, 236, 229, 129, 176, 225, 242, 136, 54,  29,  102, 19,  5,   42,  207, 136, 209,
    220, 133, 211, 105, 122, 154, 22,  206, 179, 36,  20,  57,  233, 132, 144, 250, 30,  9,   202,
    120, 106, 127, 52,  29,  168, 93,  85,  210, 15,  14,  27,  129, 93,  239, 41,  110, 118, 71,
    0,   148, 200, 60,  56,  168, 2,   36,  145, 120, 119, 26,  30,  148, 50,  214, 83,  24,  65,
    4,   213, 30,  131, 177, 157, 193, 80,  192, 121, 53,  254, 179, 58,  157, 23,  95,  9,   30,
    107, 210, 255, 223, 53,  105, 43,  110, 99,  166, 82,  55,  116, 72,  182, 119, 16,  219, 31,
    45,  50,  211, 176, 130, 114, 193, 154, 17,  167, 143, 246, 85,  201, 205, 136, 68,  147, 120,
    1,   79,  103, 61,  148, 21,  14,  245, 229, 207, 218, 175, 66,  105, 83,  125, 16,  106, 216,
    198, 133, 125, 102, 136, 164, 49,  246, 14,  52,  225, 137, 98,  150, 99,  110, 247, 167, 184,
    159, 172, 255, 185, 34,  14,  249, 137, 159, 123, 242, 112, 152, 20,  105, 254, 207, 183, 250,
    108, 151, 143, 220, 120, 61,  145, 155, 116, 236, 130, 43,  14,  40,  221, 78,  204, 153, 37,
    149, 220, 151, 245, 82,  22,  171, 27,  252, 119, 68,  230, 114, 220, 11,  245, 248, 69,  162,
    80,  206, 252, 65,  230, 0,   201, 22,  242, 193, 176, 214, 59,  214, 221, 11,  226, 8,   145,
    26,  177, 1,   104, 123, 93,  35,  35,  146, 230, 115, 157, 149, 215, 194, 193, 44,  171, 167,
    161, 163, 158, 87,  68,  60,  127, 182, 91,  2,   78,  140, 199, 46,  3,   164, 239, 86,  22,
    49,  31,  106, 245, 112, 111, 46,  189, 160, 82,  202, 180, 185, 207, 207, 118, 39,  170, 251,
    3,   41,  131, 113, 121, 79,  202, 214, 217, 215, 51,  252, 69,  139, 22,  234, 143, 201, 31,
    68,  81,  165, 25,  82,  166, 192, 223, 174, 197, 153, 90,  122, 238, 223, 132, 50,  195, 70,
    207, 106, 120, 251, 28,  39,  34,  177, 169, 217, 183, 98,  81,  161, 248, 75,  54,  201, 14,
    70,  202, 39,  65,  245, 217, 16,  217, 118, 141, 147, 176, 212, 182, 170, 173, 87,  7,   252,
    64,  247, 107, 174, 137, 232, 63,  53,  227, 67,  112, 90,  232, 206, 192, 223, 12,  135, 176,
    13,  181, 49,  20,  94,  188, 113, 253, 13,  68,  143, 3,   183, 81,  134, 18,  249, 171, 180,
    47,  28,  62,  149, 4,   155, 120, 172, 184, 136, 67,  34,  231, 52,  32,  38,  121, 140, 27,
    182, 183, 35,  126, 127, 211, 60,  233, 235, 120, 177, 199, 176, 138, 53,  79,  22,  191, 150,
    77,  102, 56,  254, 154, 5,   159, 27,  209, 243, 151, 174, 90,  73,  73,  237, 138, 23,  71,
    200, 108, 17,  188, 13,  162, 223, 83,  246, 93,  229, 240, 244, 49,  44,  112, 82,  112, 90,
    178, 253, 59,  224, 48,  86,  10,  250, 216, 95,  179, 74,  77,  249, 94,  15,  76,  14,  167,
    79,  46,  235, 72,  26,  185, 28,  124, 69,  42,  97,  23,  34,  60,  191, 29,  42,  29,  241,
    113, 176, 110, 36,  153, 201, 46,  226, 40,  138, 149, 79,  23,  151, 104, 83,  91,  70,  189,
    68,  225, 201, 98,  207, 172, 102, 102, 168, 121, 129, 65,  125, 26,  85,  212, 158, 60,  100,
    16,  169, 207, 206, 11,  4,   95,  136, 94,  3,   101, 217, 41,  23,  29,  70,  26,  189, 72,
    147, 40,  99,  90,  48,  51,  161, 42,  25,  45,  103, 182, 62,  91,  8,   50,  67,  3,   84,
    228, 126, 193, 138, 105, 48,  119, 238, 218, 61,  112, 132, 89,  34,  236, 18,  136, 175, 204,
    168, 11,  39,  233, 236, 82,  147, 193, 172, 198, 90,  240, 102, 105, 32,  7,   102, 43,  72,
    222, 159, 57,  101, 218, 193, 75,  119, 133, 186, 114, 92,  234, 47,  13,  95,  49,  42,  42,
    104, 27,  203, 74,  123, 104, 92,  69,  63,  76,  43,  161, 188, 191, 4,   25,  67,  43,  229,
    14,  82,  1,   249, 117, 37,  8,   168, 153, 92,  160, 8,   242, 210, 144, 255, 114, 89,  154,
    112, 161, 186, 119, 214, 131, 209, 61,  33,  27,  7,   239, 244, 62,  24,  245, 123, 252, 124,
    136, 30,  25,  128, 53,  233, 108, 201, 140, 30,  78,  79,  196, 229, 70,  203, 60,  151, 149,
    184, 211, 211, 211, 129, 156, 63,  10,  50,  29,  91,  156, 45,  122, 54,  202, 212, 3,   93,
    82,  29,  17,  207, 132, 190, 151, 179, 92,  194, 197, 125, 128, 141, 81,  64,  161, 55,  191,
    137, 184, 210, 183, 204, 105, 151, 43,  245, 16,  63,  4,   108, 108, 87,  135, 70,  213, 136,
    59,  137, 220, 226, 158, 86,  222, 25,  233, 244, 26,  30 };

static const uchar shred13_data_bytes[FD_SHRED_MIN_SZ] = {
    6,   110, 124, 101, 85,  227, 31,  118, 212, 51,  144, 98,  206, 54,  48,  235, 150, 181, 132,
    90,  80,  148, 32,  68,  132, 1,   63,  174, 55,  97,  169, 212, 152, 60,  94,  218, 60,  35,
    11,  83,  80,  254, 240, 65,  155, 177, 102, 175, 55,  136, 16,  76,  198, 216, 26,  80,  167,
    18,  114, 178, 62,  109, 213, 3,   133, 42,  0,   0,   0,   0,   0,   0,   0,   13,  0,   0,
    0,   42,  0,   13,  0,   0,   0,   1,   0,   42,  79,  4,   68,  226, 106, 240, 224, 45,  152,
    233, 54,  71,  16,  187, 90,  189, 211, 29,  246, 221, 83,  123, 68,  195, 87,  226, 230, 21,
    219, 26,  115, 105, 57,  129, 79,  47,  64,  89,  9,   43,  213, 80,  230, 163, 44,  98,  11,
    114, 235, 125, 151, 110, 18,  84,  237, 80,  212, 59,  90,  77,  5,   2,   102, 102, 166, 21,
    53,  8,   19,  233, 5,   107, 237, 59,  113, 212, 128, 94,  43,  26,  187, 34,  141, 36,  232,
    18,  16,  194, 88,  244, 54,  207, 212, 189, 183, 143, 181, 11,  30,  192, 192, 235, 251, 219,
    242, 5,   88,  27,  138, 8,   122, 185, 29,  78,  248, 121, 240, 254, 10,  215, 175, 3,   253,
    175, 51,  184, 117, 208, 37,  183, 71,  143, 60,  250, 255, 180, 124, 17,  177, 155, 174, 196,
    226, 87,  155, 3,   1,   192, 216, 170, 5,   49,  20,  217, 226, 129, 178, 119, 227, 207, 162,
    109, 18,  232, 138, 239, 73,  9,   98,  123, 208, 132, 22,  200, 149, 32,  53,  141, 93,  79,
    12,  40,  184, 133, 71,  229, 193, 177, 168, 73,  182, 245, 6,   52,  52,  153, 209, 91,  172,
    172, 41,  207, 235, 139, 176, 214, 3,   175, 41,  144, 73,  120, 173, 135, 137, 61,  162, 142,
    136, 123, 122, 210, 84,  84,  1,   134, 77,  90,  246, 109, 204, 4,   189, 64,  122, 182, 134,
    199, 65,  22,  132, 240, 165, 2,   124, 131, 240, 171, 120, 157, 146, 95,  228, 165, 9,   19,
    74,  98,  78,  92,  139, 68,  73,  23,  225, 111, 234, 177, 132, 199, 185, 158, 58,  67,  60,
    10,  235, 62,  42,  90,  218, 142, 27,  109, 143, 142, 255, 134, 64,  48,  42,  33,  204, 132,
    209, 178, 33,  153, 233, 6,   86,  206, 186, 121, 21,  131, 234, 32,  240, 188, 31,  229, 223,
    32,  1,   58,  226, 112, 33,  130, 27,  155, 27,  230, 158, 136, 43,  119, 14,  15,  122, 53,
    56,  8,   29,  208, 165, 65,  123, 203, 196, 96,  183, 129, 62,  27,  67,  227, 210, 135, 35,
    102, 149, 46,  59,  223, 50,  98,  15,  146, 200, 107, 147, 61,  190, 198, 149, 41,  157, 165,
    113, 176, 157, 77,  181, 239, 49,  171, 54,  170, 127, 243, 239, 58,  123, 22,  184, 79,  200,
    47,  139, 25,  6,   191, 196, 28,  87,  212, 47,  250, 20,  201, 103, 93,  183, 45,  37,  24,
    134, 204, 79,  192, 80,  142, 233, 121, 199, 10,  164, 15,  223, 116, 216, 136, 180, 182, 211,
    148, 188, 66,  59,  91,  78,  15,  185, 65,  212, 228, 190, 34,  68,  57,  251, 25,  77,  118,
    43,  29,  154, 153, 149, 138, 67,  57,  221, 49,  63,  152, 199, 120, 64,  222, 18,  6,   246,
    181, 149, 224, 30,  28,  19,  55,  226, 34,  246, 202, 62,  171, 149, 90,  102, 205, 12,  5,
    87,  223, 217, 42,  151, 206, 22,  137, 232, 211, 201, 96,  175, 168, 149, 82,  16,  220, 231,
    187, 169, 129, 196, 250, 213, 128, 44,  230, 142, 40,  144, 174, 177, 67,  27,  172, 255, 220,
    204, 124, 162, 152, 206, 52,  27,  118, 71,  217, 215, 224, 220, 124, 87,  178, 223, 120, 127,
    5,   148, 45,  43,  194, 52,  194, 151, 89,  31,  90,  17,  224, 198, 126, 1,   68,  25,  92,
    11,  133, 235, 127, 227, 22,  184, 129, 67,  79,  62,  202, 86,  52,  158, 198, 62,  51,  116,
    128, 36,  53,  205, 77,  184, 216, 18,  91,  244, 250, 104, 41,  220, 185, 94,  135, 104, 139,
    103, 237, 159, 94,  42,  201, 197, 140, 145, 221, 222, 217, 71,  77,  107, 102, 131, 91,  61,
    86,  199, 61,  70,  90,  164, 47,  26,  95,  52,  61,  192, 167, 85,  197, 28,  106, 134, 110,
    164, 229, 239, 215, 162, 41,  142, 105, 111, 77,  163, 145, 212, 30,  156, 5,   52,  115, 12,
    7,   70,  186, 255, 205, 121, 153, 248, 252, 235, 199, 9,   86,  240, 185, 61,  189, 168, 15,
    236, 254, 192, 66,  66,  173, 188, 122, 67,  56,  5,   36,  10,  38,  112, 61,  47,  246, 59,
    138, 18,  7,   22,  67,  238, 93,  135, 7,   210, 35,  227, 171, 93,  38,  176, 81,  5,   109,
    26,  67,  246, 8,   41,  248, 165, 167, 180, 212, 64,  38,  8,   179, 68,  228, 246, 184, 107,
    21,  241, 36,  240, 191, 84,  151, 82,  221, 174, 3,   200, 19,  236, 179, 21,  92,  123, 14,
    156, 236, 203, 95,  100, 28,  210, 104, 169, 61,  162, 243, 37,  151, 47,  148, 62,  126, 39,
    201, 114, 165, 121, 4,   32,  84,  227, 28,  96,  119, 195, 250, 9,   223, 143, 101, 140, 153,
    117, 78,  52,  17,  191, 240, 104, 19,  3,   107, 29,  71,  166, 185, 106, 113, 172, 100, 51,
    98,  126, 196, 209, 244, 77,  176, 70,  77,  197, 151, 119, 141, 17,  69,  214, 147, 194, 64,
    88,  199, 170, 72,  152, 182, 111, 93,  255, 30,  241, 170, 189, 143, 198, 32,  104, 123, 134,
    168, 162, 248, 242, 192, 84,  85,  36,  193, 92,  174, 151, 169, 156, 187, 205, 203, 178, 70,
    32,  215, 172, 83,  175, 247, 2,   215, 96,  244, 152, 0,   213, 127, 142, 100, 69,  44,  212,
    153, 94,  238, 99,  188, 74,  98,  100, 18,  198, 182, 48,  99,  207, 23,  149, 127, 250, 74,
    99,  45,  115, 32,  149, 246, 105, 42,  244, 219, 16,  162, 11,  78,  122, 229, 26,  22,  209,
    250, 87,  151, 165, 171, 172, 42,  59,  164, 70,  236, 228, 229, 79,  91,  254, 27,  79,  239,
    98,  247, 217, 61,  61,  193, 134, 3,   74,  224, 222, 51,  15,  198, 142, 85,  11,  249, 15,
    16,  111, 44,  184, 50,  202, 131, 85,  194, 50,  214, 34,  184, 98,  156, 161, 117, 21,  137,
    203, 41,  34,  31,  0,   172, 223, 61,  26,  21,  246, 98,  105, 229, 53,  223, 203, 135, 244,
    87,  42,  249, 139, 32,  190, 28,  57,  6,   87,  37,  234, 26,  115, 57,  37,  54,  189, 74,
    77,  168, 73,  246, 42,  176, 180, 233, 167, 194, 80,  207, 124, 32,  94,  229, 25,  48,  40,
    85,  1,   106, 8,   141, 91,  47,  230, 217, 110, 156, 213, 108, 39,  197, 35,  102, 99,  47,
    201, 14,  114, 235, 231, 60,  119, 223, 81,  10,  60,  15,  78,  187, 39,  197, 80,  64,  96,
    0,   157, 26,  55,  5,   180, 219, 183, 158, 237, 30,  228, 47,  152, 206, 68,  202, 17,  111,
    188, 96,  54,  8,   221, 80,  228, 234, 214, 35,  22,  172, 65,  217, 165, 190, 30,  147, 39,
    193, 214, 157, 222, 255, 181 };

static const uchar shred13_data_bytes_eqvoc[FD_SHRED_MIN_SZ] = {
    231, 55,  111, 140, 57,  159, 84,  2,   69,  28,  60,  138, 91,  207, 27,  144, 226, 213, 244,
    133, 134, 71,  120, 190, 239, 225, 110, 38,  196, 207, 75,  201, 149, 131, 80,  231, 218, 244,
    168, 179, 253, 221, 211, 118, 147, 243, 170, 234, 173, 89,  247, 74,  63,  110, 65,  232, 94,
    234, 146, 221, 121, 249, 194, 15,  133, 42,  0,   0,   0,   0,   0,   0,   0,   13,  0,   0,
    0,   42,  0,   13,  0,   0,   0,   1,   0,   42,  79,  4,   237, 248, 73,  77,  173, 95,  27,
    47,  14,  141, 238, 91,  139, 242, 196, 136, 240, 216, 122, 126, 173, 230, 220, 80,  161, 39,
    93,  131, 88,  234, 217, 30,  99,  183, 58,  63,  147, 24,  90,  68,  165, 44,  200, 172, 160,
    137, 253, 151, 178, 141, 88,  19,  241, 18,  130, 124, 27,  223, 40,  4,   45,  181, 53,  232,
    136, 180, 3,   79,  230, 205, 59,  165, 227, 161, 229, 47,  105, 215, 154, 227, 142, 16,  15,
    117, 20,  205, 249, 58,  101, 103, 163, 214, 115, 254, 133, 204, 114, 46,  155, 160, 214, 161,
    15,  93,  126, 87,  35,  142, 23,  67,  204, 207, 201, 135, 228, 166, 131, 91,  5,   64,  63,
    120, 243, 72,  61,  53,  109, 227, 125, 68,  173, 211, 205, 58,  105, 12,  193, 218, 206, 187,
    127, 21,  214, 233, 109, 24,  68,  31,  132, 129, 63,  125, 108, 31,  202, 83,  173, 29,  154,
    185, 64,  78,  30,  113, 216, 22,  34,  101, 199, 94,  195, 242, 188, 156, 125, 109, 135, 208,
    131, 78,  211, 127, 82,  17,  163, 39,  16,  237, 3,   166, 1,   127, 153, 208, 242, 219, 193,
    56,  16,  56,  181, 191, 39,  15,  25,  214, 249, 134, 36,  214, 38,  172, 238, 210, 110, 248,
    238, 243, 21,  50,  184, 164, 236, 60,  61,  136, 86,  144, 220, 115, 241, 59,  144, 123, 181,
    146, 187, 163, 86,  67,  45,  190, 177, 221, 177, 161, 23,  142, 186, 117, 131, 8,   101, 241,
    222, 231, 149, 133, 226, 195, 37,  35,  156, 214, 131, 124, 132, 147, 82,  24,  22,  150, 139,
    90,  26,  171, 129, 246, 56,  146, 3,   117, 112, 77,  47,  22,  137, 151, 14,  158, 45,  181,
    47,  80,  56,  190, 173, 116, 215, 109, 110, 220, 31,  139, 252, 210, 117, 67,  183, 53,  237,
    12,  198, 212, 116, 54,  201, 75,  50,  190, 129, 171, 150, 3,   68,  228, 26,  248, 183, 94,
    184, 175, 218, 73,  86,  175, 86,  41,  0,   198, 57,  243, 13,  54,  80,  245, 129, 226, 28,
    117, 191, 166, 24,  112, 182, 238, 228, 93,  121, 37,  114, 145, 57,  63,  4,   235, 21,  228,
    255, 168, 21,  126, 38,  41,  197, 120, 111, 31,  93,  184, 229, 236, 86,  31,  102, 128, 20,
    230, 97,  151, 74,  131, 255, 69,  61,  43,  39,  203, 83,  43,  90,  66,  7,   149, 30,  122,
    3,   107, 26,  204, 223, 57,  191, 211, 251, 189, 142, 152, 147, 44,  36,  74,  40,  59,  63,
    239, 247, 182, 218, 15,  220, 245, 42,  154, 224, 146, 104, 46,  32,  128, 98,  29,  156, 108,
    253, 33,  116, 151, 185, 59,  45,  232, 241, 83,  51,  97,  205, 79,  221, 179, 90,  54,  234,
    89,  125, 175, 133, 130, 18,  23,  43,  68,  98,  20,  62,  100, 10,  193, 106, 79,  64,  6,
    42,  134, 245, 44,  22,  120, 50,  179, 215, 28,  99,  44,  42,  27,  177, 117, 52,  47,  117,
    132, 137, 42,  214, 229, 250, 121, 84,  19,  227, 242, 118, 147, 32,  39,  169, 133, 2,   47,
    213, 50,  188, 98,  142, 225, 219, 206, 169, 201, 68,  103, 124, 126, 87,  85,  119, 20,  123,
    24,  190, 42,  225, 210, 11,  47,  224, 152, 112, 106, 195, 44,  107, 136, 113, 171, 121, 227,
    21,  165, 91,  177, 233, 125, 229, 224, 91,  170, 42,  224, 29,  84,  62,  9,   74,  99,  169,
    245, 48,  96,  152, 113, 54,  176, 215, 207, 180, 206, 59,  253, 45,  107, 195, 124, 79,  162,
    157, 248, 3,   64,  77,  81,  185, 50,  105, 204, 72,  66,  163, 45,  132, 15,  253, 73,  213,
    4,   56,  134, 97,  160, 217, 223, 61,  0,   107, 52,  159, 45,  57,  197, 207, 245, 39,  199,
    222, 171, 163, 248, 91,  43,  54,  203, 176, 7,   28,  152, 247, 227, 170, 192, 119, 97,  28,
    181, 61,  18,  176, 250, 254, 22,  131, 104, 131, 201, 57,  35,  116, 214, 36,  246, 125, 145,
    102, 10,  165, 19,  31,  233, 110, 46,  79,  235, 90,  235, 177, 249, 1,   9,   244, 60,  37,
    245, 104, 154, 185, 79,  42,  129, 172, 10,  58,  123, 119, 34,  83,  245, 94,  92,  126, 58,
    150, 4,   70,  251, 251, 94,  81,  184, 113, 225, 234, 101, 66,  125, 50,  223, 255, 122, 29,
    152, 14,  43,  54,  161, 112, 183, 10,  31,  193, 61,  87,  71,  180, 165, 237, 221, 47,  40,
    219, 49,  214, 24,  194, 254, 253, 100, 66,  112, 147, 167, 2,   147, 61,  99,  38,  5,   145,
    53,  133, 244, 145, 233, 135, 216, 14,  194, 162, 175, 243, 227, 34,  228, 154, 76,  136, 17,
    105, 35,  73,  222, 196, 45,  25,  116, 86,  18,  35,  202, 128, 150, 10,  13,  65,  252, 203,
    155, 203, 21,  105, 16,  144, 164, 60,  193, 213, 12,  89,  234, 149, 94,  100, 195, 118, 3,
    159, 212, 156, 14,  22,  27,  163, 199, 164, 132, 177, 192, 187, 144, 9,   69,  170, 65,  240,
    180, 97,  215, 53,  15,  37,  54,  233, 112, 186, 69,  6,   50,  199, 199, 255, 84,  200, 187,
    70,  30,  35,  164, 155, 217, 39,  76,  18,  166, 13,  195, 240, 96,  168, 80,  113, 161, 26,
    161, 25,  198, 152, 61,  61,  252, 126, 71,  65,  121, 231, 37,  57,  159, 231, 168, 125, 41,
    87,  88,  83,  83,  53,  255, 231, 178, 235, 190, 96,  148, 9,   37,  202, 101, 61,  77,  159,
    41,  56,  166, 205, 14,  80,  157, 95,  253, 149, 161, 129, 20,  102, 221, 248, 24,  113, 79,
    13,  132, 165, 172, 112, 37,  193, 50,  71,  30,  121, 68,  134, 206, 253, 141, 86,  41,  164,
    60,  23,  89,  102, 121, 248, 177, 25,  70,  213, 28,  89,  140, 126, 104, 80,  178, 28,  91,
    129, 16,  245, 186, 216, 234, 153, 4,   160, 43,  190, 35,  251, 47,  18,  223, 89,  19,  165,
    168, 199, 61,  65,  138, 173, 41,  170, 220, 139, 147, 100, 150, 8,   191, 233, 12,  215, 54,
    157, 134, 227, 238, 138, 221, 206, 89,  197, 124, 137, 5,   81,  70,  72,  104, 78,  218, 175,
    77,  137, 95,  23,  251, 69,  57,  201, 13,  231, 46,  114, 14,  10,  69,  141, 191, 101, 122,
    163, 194, 218, 87,  73,  156, 128, 12,  201, 2,   253, 192, 7,   145, 151, 218, 14,  97,  14,
    219, 139, 186, 84,  168, 121, 3,   126, 126, 189, 130, 199, 150, 93,  107, 162, 139, 27,  22,
    57,  139, 140, 148, 208, 125, 171, 41,  253, 125, 80,  59,  60,  240, 117, 114, 248, 60,  188,
    94,  70,  62,  35,  141, 193 };
