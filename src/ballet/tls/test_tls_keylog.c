#include "fd_tls_keylog.h"


struct fd_tls_keylog_test_vector {
  ulong           str_sz;
  char const *    str;
  fd_tls_keylog_t keylog;
};
typedef struct fd_tls_keylog_test_vector fd_tls_keylog_test_vector_t;


static fd_tls_keylog_test_vector_t const
fd_tls_keylog_test_vector[] = {
  { .str_sz = 162UL,
    .str    = "CLIENT_HANDSHAKE_TRAFFIC_SECRET 6ef62654a1598fd31dc1a31c2450b3a8a4cfb27b2aaa914d80b55803d8c1277d f0d16f4cdebdeaf1e47c33efe25195b8967670fa8d4bff57deec2566ead2cadf\n",
    .keylog = {
      .label         = FD_TLS_KEYLOG_LABEL_CLIENT_HANDSHAKE_TRAFFIC_SECRET,
      .client_random = { 0x6e, 0xf6, 0x26, 0x54, 0xa1, 0x59, 0x8f, 0xd3, 0x1d, 0xc1, 0xa3, 0x1c, 0x24, 0x50, 0xb3, 0xa8, 0xa4, 0xcf, 0xb2, 0x7b, 0x2a, 0xaa, 0x91, 0x4d, 0x80, 0xb5, 0x58, 0x03, 0xd8, 0xc1, 0x27, 0x7d },
      .secret_sz     = 32U,
      .secret        = { 0xf0, 0xd1, 0x6f, 0x4c, 0xde, 0xbd, 0xea, 0xf1, 0xe4, 0x7c, 0x33, 0xef, 0xe2, 0x51, 0x95, 0xb8, 0x96, 0x76, 0x70, 0xfa, 0x8d, 0x4b, 0xff, 0x57, 0xde, 0xec, 0x25, 0x66, 0xea, 0xd2, 0xca, 0xdf }
    } },
  { .str_sz = 162UL,
    .str    = "SERVER_HANDSHAKE_TRAFFIC_SECRET 6ef62654a1598fd31dc1a31c2450b3a8a4cfb27b2aaa914d80b55803d8c1277d 0bc4580f6a4e834b08f17416869a620fe383a172992aaec01bab00d95c624c1a\n",
    .keylog = {
      .label         = FD_TLS_KEYLOG_LABEL_SERVER_HANDSHAKE_TRAFFIC_SECRET,
      .client_random = { 0x6e, 0xf6, 0x26, 0x54, 0xa1, 0x59, 0x8f, 0xd3, 0x1d, 0xc1, 0xa3, 0x1c, 0x24, 0x50, 0xb3, 0xa8, 0xa4, 0xcf, 0xb2, 0x7b, 0x2a, 0xaa, 0x91, 0x4d, 0x80, 0xb5, 0x58, 0x03, 0xd8, 0xc1, 0x27, 0x7d },
      .secret_sz     = 32U,
      .secret        = { 0x0b, 0xc4, 0x58, 0x0f, 0x6a, 0x4e, 0x83, 0x4b, 0x08, 0xf1, 0x74, 0x16, 0x86, 0x9a, 0x62, 0x0f, 0xe3, 0x83, 0xa1, 0x72, 0x99, 0x2a, 0xae, 0xc0, 0x1b, 0xab, 0x00, 0xd9, 0x5c, 0x62, 0x4c, 0x1a }
    } },
  { .str_sz = 154UL,
    .str    = "CLIENT_TRAFFIC_SECRET_4 6ef62654a1598fd31dc1a31c2450b3a8a4cfb27b2aaa914d80b55803d8c1277d e6f95e2f0c9303a35ae4675626bb4913876efad9778f1a43503dfac0c59423dd\n",
    .keylog = {
      .label         = FD_TLS_KEYLOG_LABEL_CLIENT_TRAFFIC_SECRET,
      .counter       = 4,
      .client_random = { 0x6e, 0xf6, 0x26, 0x54, 0xa1, 0x59, 0x8f, 0xd3, 0x1d, 0xc1, 0xa3, 0x1c, 0x24, 0x50, 0xb3, 0xa8, 0xa4, 0xcf, 0xb2, 0x7b, 0x2a, 0xaa, 0x91, 0x4d, 0x80, 0xb5, 0x58, 0x03, 0xd8, 0xc1, 0x27, 0x7d },
      .secret_sz     = 32U,
      .secret        = { 0xe6, 0xf9, 0x5e, 0x2f, 0x0c, 0x93, 0x03, 0xa3, 0x5a, 0xe4, 0x67, 0x56, 0x26, 0xbb, 0x49, 0x13, 0x87, 0x6e, 0xfa, 0xd9, 0x77, 0x8f, 0x1a, 0x43, 0x50, 0x3d, 0xfa, 0xc0, 0xc5, 0x94, 0x23, 0xdd }
    } },
  { .str_sz = 153UL,
    .str    = "SERVER_TRAFFIC_SECRET_9 6ef62654a1598fd31dc1a31c2450b3a8a4cfb27b2aaa914d80b55803d8c1277d 272bf20763fe59ae71605682509bba35b84b43fd24a50f7e4f869e4244a3bdcd",
    .keylog = {
      .label         = FD_TLS_KEYLOG_LABEL_SERVER_TRAFFIC_SECRET,
      .counter       = 9,
      .client_random = { 0x6e, 0xf6, 0x26, 0x54, 0xa1, 0x59, 0x8f, 0xd3, 0x1d, 0xc1, 0xa3, 0x1c, 0x24, 0x50, 0xb3, 0xa8, 0xa4, 0xcf, 0xb2, 0x7b, 0x2a, 0xaa, 0x91, 0x4d, 0x80, 0xb5, 0x58, 0x03, 0xd8, 0xc1, 0x27, 0x7d },
      .secret_sz     = 32U,
      .secret        = { 0x27, 0x2b, 0xf2, 0x07, 0x63, 0xfe, 0x59, 0xae, 0x71, 0x60, 0x56, 0x82, 0x50, 0x9b, 0xba, 0x35, 0xb8, 0x4b, 0x43, 0xfd, 0x24, 0xa5, 0x0f, 0x7e, 0x4f, 0x86, 0x9e, 0x42, 0x44, 0xa3, 0xbd, 0xcd }
    } },
  {0}
};


int
main( int     argc,
      char ** argv ) {
  fd_boot( &argc, &argv );

  for( fd_tls_keylog_test_vector_t const * vec = fd_tls_keylog_test_vector; vec->str; vec++ ) {
    fd_tls_keylog_t keylog;
    FD_TEST( fd_tls_keylog_parse( &keylog, vec->str, vec->str_sz )==vec->str_sz );
    FD_TEST( 0==memcmp( &keylog, &vec->keylog, sizeof(fd_tls_keylog_t) ) );
  }

  FD_LOG_NOTICE(( "pass" ));
  fd_halt();
  return 0;
}

