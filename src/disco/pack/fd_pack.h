#ifndef HEADER_fd_src_disco_pack_fd_pack_h
#define HEADER_fd_src_disco_pack_fd_pack_h

/* fd_pack provides services to packlicate multiple streams of input
   fragments and present them to a mix of reliable and unreliable
   consumers as though they were generated by a single multi-stream
   producer.

   The pack tile is simply a wrapper around the mux tile, that also
   checks the transaction signature field for duplicates and filters
   them out. */

#include "../fd_disco_base.h"

#include "../../ballet/pack/fd_pack.h"

/* in bytes.  Defined this way to use the size field of mcache */
#define MAX_MICROBLOCK_SZ USHORT_MAX

typedef struct {
  void * wksp;
  ulong  chunk0;
  ulong  wmark;
} fd_pack_in_ctx_t;

#define FD_PACK_TILE_SCRATCH_ALIGN (128UL)
#define FD_PACK_TILE_SCRATCH_FOOTPRINT( in_cnt, out_cnt )                            \
  FD_LAYOUT_FINI( FD_LAYOUT_APPEND( FD_LAYOUT_APPEND( FD_LAYOUT_INIT,                \
    alignof(fd_pack_in_ctx_t), (in_cnt)*sizeof(fd_pack_in_ctx_t) ),                  \
    FD_MUX_TILE_SCRATCH_ALIGN,   FD_MUX_TILE_SCRATCH_FOOTPRINT( in_cnt, out_cnt ) ), \
    FD_PACK_TILE_SCRATCH_ALIGN )

FD_PROTOTYPES_BEGIN

int
fd_pack_tile( fd_cnc_t *              cnc,       /* Local join to the packs's command-and-control */
              ulong                   pid,       /* Tile PID for diagnostic purposes */
              ulong                   in_cnt,    /* Number of input mcaches to multiplex, inputs are indexed [0,in_cnt) */
              fd_frag_meta_t const ** in_mcache, /* in_mcache[in_idx] is the local join to input in_idx's mcache */
              ulong **                in_fseq,   /* in_fseq  [in_idx] is the local join to input in_idx's fseq */
              uchar const **          in_dcache, /* in_dcache[in_idx] is the local join to input in_idx's dcache */
              fd_pack_t *             pack,      /* Local join to the pack's pack object */
              fd_frag_meta_t *        mcache,    /* Local join to the packs's frag stream output mcache */
              uchar *                 dcache,    /* Local join to the packs's frag stream output dcache */
              ulong                   out_cnt,   /* Number of reliable consumers, reliable consumers are indexed [0,out_cnt) */
              ulong **                out_fseq,  /* out_fseq[out_idx] is the local join to reliable consumer out_idx's fseq */
              ulong **                out_busy,  /* out_busy[out_idx] is the local join to reliable consumer out_idx's busy fseq */
              ulong                   cr_max,    /* Maximum number of flow control credits, 0 means use a reasonable default */
              long                    lazy,      /* Lazyiness, <=0 means use a reasonable default */
              fd_rng_t *              rng,       /* Local join to the rng this packs should use */
              void *                  scratch ); /* Tile scratch memory */

FD_PROTOTYPES_END

#endif /* HEADER_fd_src_disco_pack_fd_pack_h */
